<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Meal Price Trends</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    #controls {
      margin-bottom: 20px;
    }
    svg {
      border: 1px solid #ccc;
    }

    .tooltip {
    position: absolute;
    text-align: left;
    line-height: 1.4;
    padding: 8px;
    background: rgba(0, 0, 0, 0.75);
    color: white;
    border-radius: 5px;
    pointer-events: none;
    font-family: sans-serif;
    }
  </style>
</head>
<body>

<h2>Meal Price Trends</h2>

<div id="controls">
  <label>Restaurant:
    <select id="restaurantFilter"></select>
  </label>
  <label>Meal Type:
    <select id="mealFilter"></select>
  </label>
</div>

<div id="chart"></div>

<script>
  // Set up dimensions
  const margin = { top: 20, right: 30, bottom: 50, left: 60 },
        width = 800 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

  const svg = d3.select("#chart")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

  // Load CSV data
  d3.csv("menu_items2.csv").then(data => {
    // Normalize meal types to "Breakfast", "Lunch", "Dinner", or "Others"
    data.forEach(d => {
        d.date = new Date(d.date);
        
        let priceNum = parseFloat(d.price.replace("RM", "").trim());
        d.price = isNaN(priceNum) ? 0.00 : priceNum;

        const meal = d.meal_type.toLowerCase();
        if (meal.includes("breakfast")) d.meal_type = "Breakfast";
        else if (meal.includes("lunch")) d.meal_type = "Lunch";
        else if (meal.includes("dinner")) d.meal_type = "Dinner";
        else d.meal_type = "Others";
    });

    // Create dropdown options
    const restaurants = Array.from(new Set(data.map(d => d.restaurant_name)));
    const mealTypes = Array.from(new Set(data.map(d => d.meal_type)));

    const restaurantSelect = d3.select("#restaurantFilter");
    const mealSelect = d3.select("#mealFilter");

    restaurantSelect.selectAll("option")
      .data(["All", ...restaurants])
      .enter()
      .append("option")
      .text(d => d);

    mealSelect.selectAll("option")
      .data(["All", ...mealTypes])
      .enter()
      .append("option")
      .text(d => d);

    // Update chart function
    function updateChart(filteredData) {
      // Clear previous chart
      svg.selectAll("*").remove();

      // Scales
      const x = d3.scaleTime()
        .domain(d3.extent(filteredData, d => d.date))
        .range([0, width]);

      const y = d3.scaleLinear()
        .domain([0, d3.max(filteredData, d => d.price) + 1])
        .range([height, 0]);

      // Axes
      svg.append("g")
        .attr("transform", `translate(0,${height})`)
        .call(d3.axisBottom(x).ticks(6));

      svg.append("g")
        .call(d3.axisLeft(y));

      // Line generator
      const line = d3.line()
        .x(d => x(d.date))
        .y(d => y(d.price));

      // Draw line
      svg.append("path")
        .datum(filteredData)
        .attr("fill", "none")
        .attr("stroke", "steelblue")
        .attr("stroke-width", 2)
        .attr("d", line);

    // Create a tooltip div (outside SVG)
    const tooltip = d3.select("body")
    .append("div")
    .attr("class", "tooltip")
    .style("position", "absolute")
    .style("padding", "8px")
    .style("background", "rgba(0,0,0,0.75)")
    .style("color", "#fff")
    .style("border-radius", "4px")
    .style("font-size", "13px")
    .style("pointer-events", "none")
    .style("opacity", 0);

    // Add dots with tooltip
    svg.selectAll("circle")
    .data(filteredData)
    .enter()
    .append("circle")
    .attr("cx", d => x(d.date))
    .attr("cy", d => y(d.price))
    .attr("r", 5)
    .attr("fill", "orange")
    .on("mouseover", function(event, d) {
        tooltip.transition().duration(200).style("opacity", 1);
        tooltip.html(`
        <strong>Date:</strong> ${d.date.toLocaleDateString()}<br>
        <strong>Meal:</strong> ${d.dish_name}<br>
        <strong>Restaurant:</strong> ${d.restaurant_name}<br>
        <strong>Price:</strong> RM${d.price.toFixed(2)}<br>
        <strong>Type:</strong> ${d.meal_type}
        `)
        .style("left", (event.pageX + 10) + "px")
        .style("top", (event.pageY - 28) + "px");
    })
    .on("mouseout", () => {
        tooltip.transition().duration(300).style("opacity", 0);
    });

    }

    // Filter handler
    function filterData() {
      let selectedRestaurant = restaurantSelect.node().value;
      let selectedMeal = mealSelect.node().value;

      let filtered = data;

      if (selectedRestaurant !== "All") {
        filtered = filtered.filter(d => d.restaurant_name === selectedRestaurant);
      }
      if (selectedMeal !== "All") {
        filtered = filtered.filter(d => d.meal_type === selectedMeal);
      }

      updateChart(filtered);
    }

    // Initial chart
    updateChart(data);

    // Event listeners
    restaurantSelect.on("change", filterData);
    mealSelect.on("change", filterData);
  });
</script>

</bo